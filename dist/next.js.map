{"version":3,"sources":["../src/next.ts"],"sourcesContent":["import { NextResponse, type NextRequest } from 'next/server';\nimport * as jose from 'jose';\n\nexport interface WithAuthOptions {\n  jwksUrl: string;\n  publicPaths?: string[];\n  loginPath?: string;\n  issuer?: string;\n  audience?: string;\n}\n\nexport function withAuth(options: WithAuthOptions) {\n  const {\n    jwksUrl,\n    publicPaths = [],\n    loginPath = '/login',\n    issuer,\n    audience,\n  } = options;\n\n  let jwks: jose.JWTVerifyGetKey | null = null;\n\n  return async function middleware(request: NextRequest) {\n    const { pathname } = request.nextUrl;\n\n    const isPublicPath = publicPaths.some((path) => {\n      if (path.endsWith('*')) {\n        return pathname.startsWith(path.slice(0, -1));\n      }\n      return pathname === path;\n    });\n\n    if (isPublicPath) {\n      return NextResponse.next();\n    }\n\n    const token =\n      request.cookies.get('watsonauth_token')?.value ||\n      request.headers.get('authorization')?.replace('Bearer ', '');\n\n    if (!token) {\n      const loginUrl = new URL(loginPath, request.url);\n      loginUrl.searchParams.set('redirect', pathname);\n      return NextResponse.redirect(loginUrl);\n    }\n\n    try {\n      if (!jwks) {\n        jwks = jose.createRemoteJWKSet(new URL(jwksUrl));\n      }\n\n      const verifyOptions: jose.JWTVerifyOptions = {};\n      if (issuer) verifyOptions.issuer = issuer;\n      if (audience) verifyOptions.audience = audience;\n\n      const { payload } = await jose.jwtVerify(token, jwks, verifyOptions);\n\n      const requestHeaders = new Headers(request.headers);\n      requestHeaders.set('x-user-id', payload.sub as string);\n      requestHeaders.set('x-user-email', payload.email as string);\n\n      return NextResponse.next({\n        request: {\n          headers: requestHeaders,\n        },\n      });\n    } catch {\n      const loginUrl = new URL(loginPath, request.url);\n      loginUrl.searchParams.set('redirect', pathname);\n\n      const response = NextResponse.redirect(loginUrl);\n      response.cookies.delete('watsonauth_token');\n      return response;\n    }\n  };\n}\n\nexport type { WithAuthOptions as NextAuthOptions };\n"],"mappings":";AAAA,SAAS,oBAAsC;AAC/C,YAAY,UAAU;AAUf,SAAS,SAAS,SAA0B;AACjD,QAAM;AAAA,IACJ;AAAA,IACA,cAAc,CAAC;AAAA,IACf,YAAY;AAAA,IACZ;AAAA,IACA;AAAA,EACF,IAAI;AAEJ,MAAI,OAAoC;AAExC,SAAO,eAAe,WAAW,SAAsB;AACrD,UAAM,EAAE,SAAS,IAAI,QAAQ;AAE7B,UAAM,eAAe,YAAY,KAAK,CAAC,SAAS;AAC9C,UAAI,KAAK,SAAS,GAAG,GAAG;AACtB,eAAO,SAAS,WAAW,KAAK,MAAM,GAAG,EAAE,CAAC;AAAA,MAC9C;AACA,aAAO,aAAa;AAAA,IACtB,CAAC;AAED,QAAI,cAAc;AAChB,aAAO,aAAa,KAAK;AAAA,IAC3B;AAEA,UAAM,QACJ,QAAQ,QAAQ,IAAI,kBAAkB,GAAG,SACzC,QAAQ,QAAQ,IAAI,eAAe,GAAG,QAAQ,WAAW,EAAE;AAE7D,QAAI,CAAC,OAAO;AACV,YAAM,WAAW,IAAI,IAAI,WAAW,QAAQ,GAAG;AAC/C,eAAS,aAAa,IAAI,YAAY,QAAQ;AAC9C,aAAO,aAAa,SAAS,QAAQ;AAAA,IACvC;AAEA,QAAI;AACF,UAAI,CAAC,MAAM;AACT,eAAY,wBAAmB,IAAI,IAAI,OAAO,CAAC;AAAA,MACjD;AAEA,YAAM,gBAAuC,CAAC;AAC9C,UAAI,OAAQ,eAAc,SAAS;AACnC,UAAI,SAAU,eAAc,WAAW;AAEvC,YAAM,EAAE,QAAQ,IAAI,MAAW,eAAU,OAAO,MAAM,aAAa;AAEnE,YAAM,iBAAiB,IAAI,QAAQ,QAAQ,OAAO;AAClD,qBAAe,IAAI,aAAa,QAAQ,GAAa;AACrD,qBAAe,IAAI,gBAAgB,QAAQ,KAAe;AAE1D,aAAO,aAAa,KAAK;AAAA,QACvB,SAAS;AAAA,UACP,SAAS;AAAA,QACX;AAAA,MACF,CAAC;AAAA,IACH,QAAQ;AACN,YAAM,WAAW,IAAI,IAAI,WAAW,QAAQ,GAAG;AAC/C,eAAS,aAAa,IAAI,YAAY,QAAQ;AAE9C,YAAM,WAAW,aAAa,SAAS,QAAQ;AAC/C,eAAS,QAAQ,OAAO,kBAAkB;AAC1C,aAAO;AAAA,IACT;AAAA,EACF;AACF;","names":[]}