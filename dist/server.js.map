{"version":3,"sources":["../src/proxy.ts","../src/userRoute.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\nimport { jwtVerify, createRemoteJWKSet } from 'jose'\n\nconst JWKS = createRemoteJWKSet(new URL('/.well-known/jwks.json', process.env.WATSON_AUTH_URL!))\n\nexport function createWatsonAuthProxy({ initPublicPaths = [] }: { initPublicPaths?: string[] }) {\n    const publicPaths = ['/login', '/callback', ...initPublicPaths]\n    return async (request: NextRequest) => {\n        const { pathname } = request.nextUrl\n\n        // Allow public paths\n        if (publicPaths.some((p) => pathname === p || pathname.startsWith('/api/public'))) {\n            return NextResponse.next()\n        }\n\n        // Get access token from cookie\n        const token = request.cookies.get('access_token')?.value\n\n        if (!token) {\n            // Redirect to Watson Auth login\n            const loginUrl = new URL('/login', process.env.WATSON_AUTH_URL)\n            loginUrl.searchParams.set('app', process.env.WATSON_AUTH_APP_SLUG!)\n            loginUrl.searchParams.set('callback', `${process.env.NEXT_PUBLIC_APP_URL}/callback`)\n            console.log('redirecting to login', loginUrl.toString())\n            return NextResponse.redirect(loginUrl)\n        }\n\n        try {\n            const { payload } = await jwtVerify(token, JWKS, {\n                issuer: process.env.WATSON_AUTH_URL\n            })\n            console.log('token verified')\n            const requestHeaders = new Headers(request.headers)\n            requestHeaders.set('x-user-id', payload.sub as string)\n            console.log('requestHeaders', requestHeaders)\n            console.log({\n                request: { headers: requestHeaders }\n            })\n            return NextResponse.next({\n                request: { headers: requestHeaders }\n            })\n        } catch (error) {\n            // Token invalid/expired - redirect to login\n            console.log('error', error)\n            const loginUrl = new URL('/login', process.env.WATSON_AUTH_URL)\n            loginUrl.searchParams.set('app', process.env.WATSON_AUTH_APP_SLUG!)\n            loginUrl.searchParams.set('callback', `${process.env.NEXT_PUBLIC_APP_URL}/callback`)\n            return NextResponse.redirect(loginUrl)\n        }\n    }\n}\n\nexport const config = {\n    matcher: ['/((?!_next/static|_next/image|favicon.ico).*)']\n}\n","import { NextRequest, NextResponse } from 'next/server'\nimport { jwtVerify, createRemoteJWKSet } from 'jose'\n\nconst JWKS = createRemoteJWKSet(new URL('/.well-known/jwks.json', process.env.WATSON_AUTH_URL!))\n\ntype WatsonUser = {\n    id: string\n    email: string\n    name: string | null\n    emailVerified: boolean\n}\n\nexport function createUserGET() {\n    return async (request: NextRequest) => {\n        const token = request.cookies.get('access_token')?.value\n\n        if (!token) {\n            return NextResponse.json({ user: null }, { status: 401 })\n        }\n\n        try {\n            const { payload } = await jwtVerify(token, JWKS, {\n                issuer: process.env.WATSON_AUTH_URL\n            })\n\n            const user: WatsonUser = {\n                id: typeof payload.sub === 'string' ? payload.sub : '',\n                email: typeof payload.email === 'string' ? payload.email : '',\n                name: typeof payload.name === 'string' ? payload.name : null,\n                emailVerified: Boolean(payload.emailVerified)\n            }\n\n            return NextResponse.json({ user })\n        } catch (error) {\n            return NextResponse.json({ user: null }, { status: 401 })\n        }\n    }\n}\n"],"mappings":";AAAA,SAAS,oBAAoB;AAE7B,SAAS,WAAW,0BAA0B;AAE9C,IAAM,OAAO,mBAAmB,IAAI,IAAI,0BAA0B,QAAQ,IAAI,eAAgB,CAAC;AAExF,SAAS,sBAAsB,EAAE,kBAAkB,CAAC,EAAE,GAAmC;AAC5F,QAAM,cAAc,CAAC,UAAU,aAAa,GAAG,eAAe;AAC9D,SAAO,OAAO,YAAyB;AACnC,UAAM,EAAE,SAAS,IAAI,QAAQ;AAG7B,QAAI,YAAY,KAAK,CAAC,MAAM,aAAa,KAAK,SAAS,WAAW,aAAa,CAAC,GAAG;AAC/E,aAAO,aAAa,KAAK;AAAA,IAC7B;AAGA,UAAM,QAAQ,QAAQ,QAAQ,IAAI,cAAc,GAAG;AAEnD,QAAI,CAAC,OAAO;AAER,YAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,IAAI,eAAe;AAC9D,eAAS,aAAa,IAAI,OAAO,QAAQ,IAAI,oBAAqB;AAClE,eAAS,aAAa,IAAI,YAAY,GAAG,QAAQ,IAAI,mBAAmB,WAAW;AACnF,cAAQ,IAAI,wBAAwB,SAAS,SAAS,CAAC;AACvD,aAAO,aAAa,SAAS,QAAQ;AAAA,IACzC;AAEA,QAAI;AACA,YAAM,EAAE,QAAQ,IAAI,MAAM,UAAU,OAAO,MAAM;AAAA,QAC7C,QAAQ,QAAQ,IAAI;AAAA,MACxB,CAAC;AACD,cAAQ,IAAI,gBAAgB;AAC5B,YAAM,iBAAiB,IAAI,QAAQ,QAAQ,OAAO;AAClD,qBAAe,IAAI,aAAa,QAAQ,GAAa;AACrD,cAAQ,IAAI,kBAAkB,cAAc;AAC5C,cAAQ,IAAI;AAAA,QACR,SAAS,EAAE,SAAS,eAAe;AAAA,MACvC,CAAC;AACD,aAAO,aAAa,KAAK;AAAA,QACrB,SAAS,EAAE,SAAS,eAAe;AAAA,MACvC,CAAC;AAAA,IACL,SAAS,OAAO;AAEZ,cAAQ,IAAI,SAAS,KAAK;AAC1B,YAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,IAAI,eAAe;AAC9D,eAAS,aAAa,IAAI,OAAO,QAAQ,IAAI,oBAAqB;AAClE,eAAS,aAAa,IAAI,YAAY,GAAG,QAAQ,IAAI,mBAAmB,WAAW;AACnF,aAAO,aAAa,SAAS,QAAQ;AAAA,IACzC;AAAA,EACJ;AACJ;;;ACnDA,SAAsB,gBAAAA,qBAAoB;AAC1C,SAAS,aAAAC,YAAW,sBAAAC,2BAA0B;AAE9C,IAAMC,QAAOD,oBAAmB,IAAI,IAAI,0BAA0B,QAAQ,IAAI,eAAgB,CAAC;AASxF,SAAS,gBAAgB;AAC5B,SAAO,OAAO,YAAyB;AACnC,UAAM,QAAQ,QAAQ,QAAQ,IAAI,cAAc,GAAG;AAEnD,QAAI,CAAC,OAAO;AACR,aAAOF,cAAa,KAAK,EAAE,MAAM,KAAK,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC5D;AAEA,QAAI;AACA,YAAM,EAAE,QAAQ,IAAI,MAAMC,WAAU,OAAOE,OAAM;AAAA,QAC7C,QAAQ,QAAQ,IAAI;AAAA,MACxB,CAAC;AAED,YAAM,OAAmB;AAAA,QACrB,IAAI,OAAO,QAAQ,QAAQ,WAAW,QAAQ,MAAM;AAAA,QACpD,OAAO,OAAO,QAAQ,UAAU,WAAW,QAAQ,QAAQ;AAAA,QAC3D,MAAM,OAAO,QAAQ,SAAS,WAAW,QAAQ,OAAO;AAAA,QACxD,eAAe,QAAQ,QAAQ,aAAa;AAAA,MAChD;AAEA,aAAOH,cAAa,KAAK,EAAE,KAAK,CAAC;AAAA,IACrC,SAAS,OAAO;AACZ,aAAOA,cAAa,KAAK,EAAE,MAAM,KAAK,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC5D;AAAA,EACJ;AACJ;","names":["NextResponse","jwtVerify","createRemoteJWKSet","JWKS"]}