{"version":3,"sources":["../src/proxy.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\nimport { jwtVerify, createRemoteJWKSet } from 'jose'\n\nconst JWKS = createRemoteJWKSet(new URL('/.well-known/jwks.json', process.env.WATSON_AUTH_URL!))\n\nexport function createWatsonAuthProxy({ initPublicPaths = [] }: { initPublicPaths?: string[] }) {\n    const publicPaths = ['/login', '/callback', ...initPublicPaths]\n    return async (request: NextRequest) => {\n        const { pathname } = request.nextUrl\n\n        // Allow public paths\n        if (publicPaths.some((p) => pathname === p || pathname.startsWith('/api/public'))) {\n            return NextResponse.next()\n        }\n\n        // Get access token from cookie\n        const token = request.cookies.get('access_token')?.value\n\n        if (!token) {\n            // Redirect to Watson Auth login\n            const loginUrl = new URL('/login', process.env.WATSON_AUTH_URL)\n            loginUrl.searchParams.set('app', process.env.WATSON_AUTH_APP_SLUG!)\n            loginUrl.searchParams.set('callback', `${process.env.NEXT_PUBLIC_APP_URL}/callback`)\n            console.log('redirecting to login', loginUrl.toString())\n            return NextResponse.redirect(loginUrl)\n        }\n\n        try {\n            await jwtVerify(token, JWKS, {\n                issuer: process.env.WATSON_AUTH_URL\n            })\n            console.log('token verified')\n            return NextResponse.next()\n        } catch (error) {\n            // Token invalid/expired - redirect to login\n            console.log('error', error)\n            const loginUrl = new URL('/login', process.env.WATSON_AUTH_URL)\n            loginUrl.searchParams.set('app', process.env.WATSON_AUTH_APP_SLUG!)\n            loginUrl.searchParams.set('callback', `${process.env.NEXT_PUBLIC_APP_URL}/callback`)\n            return NextResponse.redirect(loginUrl)\n        }\n    }\n}\n\nexport const config = {\n    matcher: ['/((?!_next/static|_next/image|favicon.ico).*)']\n}\n"],"mappings":";AAAA,SAAS,oBAAoB;AAE7B,SAAS,WAAW,0BAA0B;AAE9C,IAAM,OAAO,mBAAmB,IAAI,IAAI,0BAA0B,QAAQ,IAAI,eAAgB,CAAC;AAExF,SAAS,sBAAsB,EAAE,kBAAkB,CAAC,EAAE,GAAmC;AAC5F,QAAM,cAAc,CAAC,UAAU,aAAa,GAAG,eAAe;AAC9D,SAAO,OAAO,YAAyB;AACnC,UAAM,EAAE,SAAS,IAAI,QAAQ;AAG7B,QAAI,YAAY,KAAK,CAAC,MAAM,aAAa,KAAK,SAAS,WAAW,aAAa,CAAC,GAAG;AAC/E,aAAO,aAAa,KAAK;AAAA,IAC7B;AAGA,UAAM,QAAQ,QAAQ,QAAQ,IAAI,cAAc,GAAG;AAEnD,QAAI,CAAC,OAAO;AAER,YAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,IAAI,eAAe;AAC9D,eAAS,aAAa,IAAI,OAAO,QAAQ,IAAI,oBAAqB;AAClE,eAAS,aAAa,IAAI,YAAY,GAAG,QAAQ,IAAI,mBAAmB,WAAW;AACnF,cAAQ,IAAI,wBAAwB,SAAS,SAAS,CAAC;AACvD,aAAO,aAAa,SAAS,QAAQ;AAAA,IACzC;AAEA,QAAI;AACA,YAAM,UAAU,OAAO,MAAM;AAAA,QACzB,QAAQ,QAAQ,IAAI;AAAA,MACxB,CAAC;AACD,cAAQ,IAAI,gBAAgB;AAC5B,aAAO,aAAa,KAAK;AAAA,IAC7B,SAAS,OAAO;AAEZ,cAAQ,IAAI,SAAS,KAAK;AAC1B,YAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,IAAI,eAAe;AAC9D,eAAS,aAAa,IAAI,OAAO,QAAQ,IAAI,oBAAqB;AAClE,eAAS,aAAa,IAAI,YAAY,GAAG,QAAQ,IAAI,mBAAmB,WAAW;AACnF,aAAO,aAAa,SAAS,QAAQ;AAAA,IACzC;AAAA,EACJ;AACJ;","names":[]}