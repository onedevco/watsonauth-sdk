{"version":3,"sources":["../src/server.ts"],"sourcesContent":["import * as jose from 'jose';\nimport type { TokenPayload } from './types';\n\nexport interface VerifyTokenOptions {\n  jwksUrl: string;\n  issuer?: string;\n  audience?: string;\n}\n\nlet jwksCache: Map<string, jose.JWTVerifyGetKey> = new Map();\n\nexport async function verifyToken(\n  token: string,\n  options: VerifyTokenOptions\n): Promise<TokenPayload> {\n  const { jwksUrl, issuer, audience } = options;\n\n  let jwks = jwksCache.get(jwksUrl);\n  if (!jwks) {\n    jwks = jose.createRemoteJWKSet(new URL(jwksUrl));\n    jwksCache.set(jwksUrl, jwks);\n  }\n\n  const verifyOptions: jose.JWTVerifyOptions = {};\n  if (issuer) verifyOptions.issuer = issuer;\n  if (audience) verifyOptions.audience = audience;\n\n  const { payload } = await jose.jwtVerify(token, jwks, verifyOptions);\n\n  return {\n    sub: payload.sub as string,\n    email: payload.email as string,\n    name: (payload.name as string | null) ?? null,\n    emailVerified: payload.emailVerified as boolean,\n    appId: payload.appId as string,\n    iss: payload.iss as string,\n    aud: (Array.isArray(payload.aud) ? payload.aud[0] : payload.aud) as string,\n    exp: payload.exp as number,\n    iat: payload.iat as number,\n  };\n}\n\nexport function clearJwksCache(): void {\n  jwksCache.clear();\n}\n\nexport type { TokenPayload };\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAAsB;AAStB,IAAI,YAA+C,oBAAI,IAAI;AAE3D,eAAsB,YACpB,OACA,SACuB;AACvB,QAAM,EAAE,SAAS,QAAQ,SAAS,IAAI;AAEtC,MAAI,OAAO,UAAU,IAAI,OAAO;AAChC,MAAI,CAAC,MAAM;AACT,WAAY,wBAAmB,IAAI,IAAI,OAAO,CAAC;AAC/C,cAAU,IAAI,SAAS,IAAI;AAAA,EAC7B;AAEA,QAAM,gBAAuC,CAAC;AAC9C,MAAI,OAAQ,eAAc,SAAS;AACnC,MAAI,SAAU,eAAc,WAAW;AAEvC,QAAM,EAAE,QAAQ,IAAI,MAAW,eAAU,OAAO,MAAM,aAAa;AAEnE,SAAO;AAAA,IACL,KAAK,QAAQ;AAAA,IACb,OAAO,QAAQ;AAAA,IACf,MAAO,QAAQ,QAA0B;AAAA,IACzC,eAAe,QAAQ;AAAA,IACvB,OAAO,QAAQ;AAAA,IACf,KAAK,QAAQ;AAAA,IACb,KAAM,MAAM,QAAQ,QAAQ,GAAG,IAAI,QAAQ,IAAI,CAAC,IAAI,QAAQ;AAAA,IAC5D,KAAK,QAAQ;AAAA,IACb,KAAK,QAAQ;AAAA,EACf;AACF;AAEO,SAAS,iBAAuB;AACrC,YAAU,MAAM;AAClB;","names":[]}